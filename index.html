<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>奇美醫院跨領域全人照護討論會</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font：Noto Sans TC -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color:#f8fafc; }
    /* Custom style for radio button cards */
    .meeting-card:has(input:checked) {
        background-color: #f0fdfa; /* teal-50 */
        border-color: #14b8a6; /* teal-500 */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ========= Header ========= -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold text-teal-700">奇美醫院跨領域全人照護討論會</h1>
      <nav class="hidden md:flex space-x-6">
        <a href="#schedule" class="text-gray-600 hover:text-teal-600">會議時程</a>
        <a href="#announcements" class="text-gray-600 hover:text-teal-600">最新公告</a>
        <a href="#portals" class="text-gray-600 hover:text-teal-600">身分入口</a>
      </nav>
      <button id="mobile-menu-button" class="md:hidden">
        <i class="fas fa-bars text-2xl text-teal-700"></i>
      </button>
    </div>

    <!-- Mobile menu -->
    <div id="mobile-menu" class="hidden md:hidden bg-white px-6 pb-4">
      <a href="#schedule" class="block py-2 text-gray-600 hover:text-teal-600">會議時程</a>
      <a href="#announcements" class="block py-2 text-gray-600 hover:text-teal-600">最新公告</a>
      <a href="#portals" class="block py-2 text-gray-600 hover:text-teal-600">身分入口</a>
    </div>
  </header>

  <!-- ========= Main ========= -->
  <main class="container mx-auto px-6 py-12">
    <!-- Hero -->
    <section class="text-center mb-16">
      <h2 class="text-4xl font-bold mb-4">促進合作，提升照護品質</h2>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        我們致力於搭建一個跨專業領域的溝通平台，透過案例討論與經驗分享，共同探索全人照護的最佳實踐。
      </p>
    </section>

    <!-- Schedule + Announcements -->
    <div class="grid md:grid-cols-2 gap-12 mb-16">
      <!-- Schedule -->
      <div id="schedule" class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
        <h3 class="text-2xl font-bold mb-6 border-l-4 border-teal-500 pl-4">近期會議時程</h3>
        <div id="meetings-container" class="space-y-6">
          <p class="text-gray-500">正在讀取會議資料...</p>
        </div>
      </div>

      <!-- Announcements -->
      <div id="announcements" class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
        <h3 class="text-2xl font-bold mb-6 border-l-4 border-amber-500 pl-4">最新公告</h3>
        <div id="announcements-container" class="space-y-4">
          <p class="text-gray-500">正在讀取最新公告...</p>
        </div>
      </div>
    </div>

    <!-- Portals -->
    <div id="portals" class="pb-12">
      <h2 class="text-3xl font-bold text-center mb-10">身份入口</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <!-- 學員 -->
        <div class="bg-white p-8 rounded-xl shadow text-center flex flex-col items-center hover:-translate-y-2 transition duration-300">
          <div class="text-5xl text-teal-500 mb-4"><i class="fas fa-user-graduate"></i></div>
          <h3 class="text-2xl font-bold mb-4">學員入口</h3>
          <p class="text-gray-600 mb-6 flex-grow">請進入以填寫 IPP 表單及會議問卷。</p>
          <button onclick="openStudentModal()"
                  class="bg-teal-500 text-white font-bold py-2 px-6 rounded-full hover:bg-teal-600 transition-colors">
            學員進入
          </button>
        </div>

        <!-- 教師 -->
        <div class="bg-white p-8 rounded-xl shadow text-center flex flex-col items-center hover:-translate-y-2 transition duration-300">
          <div class="text-5xl text-sky-500 mb-4"><i class="fas fa-chalkboard-teacher"></i></div>
          <h3 class="text-2xl font-bold mb-4">教師入口</h3>
          <p class="text-gray-600 mb-6 flex-grow">請登入以查閱會議資料、管理學員名單。</p>
          <button onclick="openLoginModal('教師')" class="bg-sky-500 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-600 transition-colors">
            教師登入
          </button>
        </div>

        <!-- 管理者 -->
        <div class="bg-white p-8 rounded-xl shadow text-center flex flex-col items-center hover:-translate-y-2 transition duration-300">
          <div class="text-5xl text-purple-500 mb-4"><i class="fas fa-user-shield"></i></div>
          <h3 class="text-2xl font-bold mb-4">管理者入口</h3>
          <p class="text-gray-600 mb-6 flex-grow">請登入以進行會議管理與權限維護。</p>
          <button onclick="openLoginModal('管理者')" class="bg-purple-500 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-600 transition-colors">
            管理者登入
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- ========= Footer ========= -->
  <footer class="bg-gray-800 text-white">
    <div class="container mx-auto px-6 py-8 text-center">
      <p>&copy; 2025 奇美醫院跨領域全人照護討論會</p>
      <p class="text-sm text-gray-400 mt-1">奇美醫院教學中心製作</p>
    </div>
  </footer>

  <!-- ========= Student Modal (Simplified Flow) ========= -->
  <div id="student-modal" class="hidden fixed inset-0 bg-black/60 z-50 justify-center items-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg relative">
      <button onclick="closeStudentModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl">
        <i class="fas fa-times-circle"></i>
      </button>

      <!-- Meeting Selection -->
      <div>
        <h2 class="text-2xl font-bold text-center mb-6">請選擇會議場次</h2>
        <form id="student-meeting-form">
            <div id="meeting-list-container" class="space-y-3 max-h-64 overflow-y-auto mb-6 pr-2">
                <!-- Meeting list will be populated here by JavaScript -->
            </div>
            <button id="student-next-button" type="submit"
                    class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
              進入表單
            </button>
        </form>
      </div>
    </div>
  </div>


  <!-- ========= Login Modal (教師 / 管理者) ========= -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black/60 z-50 justify-center items-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md relative">
      <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl">
        <i class="fas fa-times-circle"></i>
      </button>

      <h2 id="modal-title" class="text-2xl font-bold text-center mb-8">登入</h2>
      <form id="login-form">
        <div class="mb-6">
          <label for="username" class="block text-gray-700 font-bold mb-2">帳號</label>
          <input id="username" name="username" type="text"
                 class="shadow border rounded-lg w-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500"
                 placeholder="請輸入帳號" required />
        </div>
        <div class="mb-6">
          <label for="login-password" class="block text-gray-700 font-bold mb-2">密碼</label>
          <div class="relative">
            <input id="login-password" name="password" type="password"
                   class="shadow border rounded-lg w-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500"
                   placeholder="請輸入密碼" required />
            <i id="toggle-password-icon" class="fas fa-eye absolute top-1/2 right-4 transform -translate-y-1/2 cursor-pointer text-gray-400 hover:text-gray-600"></i>
          </div>
        </div>
        <button type="submit"
                class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-full">
          登入
        </button>
      </form>
    </div>
  </div>

  <!-- ========= IPP iframe Modal ========= -->
  <div id="ipp-container" class="hidden fixed inset-0 bg-black/60 z-50 justify-center items-center p-4">
    <div class="relative w-full max-w-3xl h-[90vh]">
      <button onclick="closeIPP()"
              class="absolute -top-3 -right-3 bg-white rounded-full shadow p-2 text-gray-600 hover:text-red-500">
        <i class="fas fa-times"></i>
      </button>
      <iframe id="ipp-frame" src="" class="w-full h-full rounded-xl shadow-2xl border"></iframe>
    </div>
  </div>

  <!-- ========= Scripts ========= -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // This configuration will be automatically provided in the environment.
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config)
        : { apiKey: "DEMO_API_KEY", authDomain: "DEMO_AUTH_DOMAIN", projectId: "DEMO_PROJECT_ID" }; // Demo config
        
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Initialize Auth

    // The main execution starts after DOM is loaded.
    document.addEventListener('DOMContentLoaded', async () => {
        // --- AUTHENTICATION AND INITIAL DATA LOAD ---
        try {
            // Sign in anonymously to get permission to read public data
            await signInAnonymously(auth);
            console.log("Firebase: Signed in anonymously.");
            
            // Once signed in, load the public data
            await loadPublicData();
            
        } catch (error) {
            console.error("Firebase Authentication or Initial Data Load failed:", error);
            const meetingsContainer = document.getElementById('meetings-container');
            const announcementsContainer = document.getElementById('announcements-container');
            meetingsContainer.innerHTML = '<p class="text-red-500">讀取會議資料失敗，請檢查您的網路連線。</p>';
            announcementsContainer.innerHTML = '<p class="text-red-500">讀取公告失敗，請檢查您的網路連線。</p>';
            return; // Stop execution if critical init fails
        }
        
        // --- DATA LOADING LOGIC (NOW FROM FIRESTORE) ---
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
                return `${year}/${month}/${day} (${dayOfWeek})`;
            } catch (error) { return dateString; }
        }

        function formatDisplayTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (error) { return ''; }
        }

        async function loadPublicData() {
            const meetingsContainer = document.getElementById('meetings-container');
            const announcementsContainer = document.getElementById('announcements-container');

            try {
                // Fetch Meetings from Firestore
                const meetingsSnapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/meetings`));
                const storedMeetings = meetingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const upcomingMeetings = storedMeetings.filter(m => new Date(m.start) > new Date());
                upcomingMeetings.sort((a, b) => new Date(a.start) - new Date(b.start));
                const meetingsToShow = upcomingMeetings.slice(0, 3);

                if (meetingsToShow.length > 0) {
                    meetingsContainer.innerHTML = '';
                    meetingsToShow.forEach((meeting, index) => {
                        const meetingElement = document.createElement('div');
                        const newTag = index === 0 ? '<span class="ml-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full align-middle">NEW</span>' : '';
                        meetingElement.innerHTML = `
                            <div class="pb-4 border-b border-gray-200 last:border-b-0">
                                <p class="font-bold text-teal-600">${formatDisplayDate(meeting.start)} ${formatDisplayTime(meeting.start)} - ${formatDisplayTime(meeting.end)}</p>
                                <div class="flex items-center mt-1">
                                    <p class="text-gray-700 font-semibold">${meeting.title}</p>
                                    ${newTag}
                                </div>
                                <p class="text-sm text-gray-500">地點：${meeting.location}</p>
                            </div>
                        `;
                        meetingsContainer.appendChild(meetingElement);
                    });
                } else {
                     meetingsContainer.innerHTML = '<p class="text-gray-500">目前尚無排定的會議。</p>';
                }

                // Fetch Announcements from Firestore
                const announcementsSnapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/announcements`));
                const storedAnnouncements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const publishedAnnouncements = storedAnnouncements.filter(ann => ann.status === '已發布');
                publishedAnnouncements.sort((a,b) => new Date(b.publishDate) - new Date(a.publishDate));
                if (publishedAnnouncements.length > 0) {
                    announcementsContainer.innerHTML = '';
                    publishedAnnouncements.forEach(ann => {
                        const announcementElement = document.createElement('div');
                        announcementElement.innerHTML = `
                            <div class="pb-3 border-b border-gray-200 last:border-b-0">
                                <p class="font-bold text-amber-600">${ann.title}</p>
                                <p class="text-gray-600 mt-2 text-sm">${ann.content.replace(/\n/g, '<br>')}</p>
                                <p class="text-xs text-gray-400 text-right mt-2">發布於 ${formatDisplayDate(ann.publishDate)}</p>
                            </div>
                        `;
                        announcementsContainer.appendChild(announcementElement);
                    });
                } else {
                    announcementsContainer.innerHTML = '<p class="text-gray-500">目前沒有最新公告。</p>';
                }

            } catch (error) {
                console.error("Error loading data from Firestore:", error);
                meetingsContainer.innerHTML = '<p class="text-red-500">讀取會議資料失敗。</p>';
                announcementsContainer.innerHTML = '<p class="text-red-500">讀取公告失敗。</p>';
            }
        }
        
        // --- GENERAL UI LOGIC ---
        const mobileMenuBtn = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const ippContainer = document.getElementById('ipp-container');
        const ippFrame = document.getElementById('ipp-frame');
        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        
        function toggle(el, show) {
            if (show) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        }

        // --- LOGIN MODAL (Teacher/Admin) ---
        const loginModal = document.getElementById('login-modal');
        const modalTitle = document.getElementById('modal-title');
        
        window.openLoginModal = (role) => { 
            modalTitle.innerText = `${role}登入`; 
            toggle(loginModal, true); 
        };
        window.closeLoginModal = () => { 
            toggle(loginModal, false); 
            document.getElementById('login-form').reset(); 
        };
        loginModal.addEventListener('click', e => { if (e.target === loginModal) closeLoginModal(); });

        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            const role = modalTitle.innerText;
            const username = e.target.username.value;
            const password = document.getElementById('login-password').value;
            if (role.includes('教師')) {
                if (username === 'admin@gmail.com' && password === 'admin@gmail.com') {
                    window.location.href = 'https://luyun1224.github.io/CMHIPE/teacher';
                } else {
                    alert('帳號或密碼錯誤。');
                }
            } else if (role.includes('管理者')) {
                if (username === 'B20401' && password === 'B20401') {
                    window.location.href = 'https://luyun1224.github.io/CMHIPE/admin';
                } else {
                    alert('帳號或密碼錯誤。');
                }
            } else {
                alert('未知的登入角色。');
                closeLoginModal();
            }
        });

        const togglePasswordIcon = document.getElementById('toggle-password-icon');
        const loginPasswordInput = document.getElementById('login-password');
        togglePasswordIcon.addEventListener('click', function() {
            const type = loginPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            loginPasswordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // --- STUDENT MODAL ---
        const studentModal = document.getElementById('student-modal');
        const meetingListContainer = document.getElementById('meeting-list-container');
        const studentNextBtn = document.getElementById('student-next-button');

        window.openStudentModal = async () => {
            meetingListContainer.innerHTML = '<p class="text-gray-500 text-center">正在讀取會議列表...</p>';
            toggle(studentModal, true);
            
            try {
                const meetingsSnapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/meetings`));
                const storedMeetings = meetingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort all meetings by start date, newest first
                storedMeetings.sort((a,b) => new Date(b.start) - new Date(a.start));

                meetingListContainer.innerHTML = '';
                
                if (storedMeetings.length > 0) {
                    storedMeetings.forEach((meeting, index) => {
                        const meetingId = `meeting-${index}`;
                        const meetingCard = document.createElement('label');
                        meetingCard.htmlFor = meetingId;
                        meetingCard.className = 'meeting-card block p-4 border-2 border-gray-200 rounded-lg hover:bg-gray-100 cursor-pointer';
                        
                        const newTag = index === 0 ? '<span class="ml-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full align-middle">NEW</span>' : '';

                        meetingCard.innerHTML = `
                          <input type="radio" name="meeting-choice" id="${meetingId}" class="hidden" value='${JSON.stringify(meeting)}'>
                          <div class="flex items-center">
                             <p class="font-semibold text-gray-800 pointer-events-none">${meeting.title}</p>
                             ${newTag}
                          </div>
                          <p class="text-sm text-gray-500 pointer-events-none mt-1">${formatDisplayDate(meeting.start)}</p>
                        `;
                        meetingListContainer.appendChild(meetingCard);
                    });
                    meetingListContainer.addEventListener('change', () => {
                        studentNextBtn.disabled = false;
                    });
                } else {
                    meetingListContainer.innerHTML = '<p class="text-gray-500 text-center">目前沒有可供選擇的會議場次。</p>';
                }
            } catch (error) {
                console.error("Error loading meetings for student modal:", error);
                meetingListContainer.innerHTML = '<p class="text-red-500 text-center">讀取會議列表失敗。</p>';
            }
        };

        window.closeStudentModal = () => {
            toggle(studentModal, false);
            setTimeout(() => {
                document.getElementById('student-meeting-form').reset();
                studentNextBtn.disabled = true;
            }, 300);
        };
        studentModal.addEventListener('click', e => { if (e.target === studentModal) closeStudentModal(); });
        
        document.getElementById('student-meeting-form').addEventListener('submit', e => {
            e.preventDefault();
            const selectedRadio = document.querySelector('input[name="meeting-choice"]:checked');
            if (selectedRadio) {
                const selectedMeetingForStudent = JSON.parse(selectedRadio.value);
                ippFrame.src = `https://luyun1224.github.io/CMHIPE/IPP.html?meeting=${encodeURIComponent(selectedMeetingForStudent.title)}`;
                closeStudentModal();
                toggle(ippContainer, true);
            }
        });

        window.closeIPP = () => {
            ippFrame.src = '';
            toggle(ippContainer, false);
        };
    });
  </script>
</body>
</html>
