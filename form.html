<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全人照護跨領域教學討論滿意度自評表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Use Noto Sans TC for better Chinese character rendering */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* Custom styles for radio buttons to ensure they are consistently sized */
        input[type="radio"] {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* Style for table headers */
        th {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem 0.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Style for table cells */
        td {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem 0.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Left-align the first column of the table */
        td:first-child {
            text-align: left;
        }
        /* Style for the save status message */
        #saveStatus {
            transition: opacity 0.5s ease-in-out;
        }

        /* MODIFIED: Simplified modal styles, positioning is handled by Tailwind classes */
        #successMessage, #errorMessage {
            position: fixed;
            inset: 0;
            background-color: rgba(107, 114, 128, 0.5); /* bg-gray-600 bg-opacity-50 */
            overflow-y: auto;
            height: 100%;
            width: 100%;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">

            <div class="mb-6">
                <button id="backButton" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 mr-2 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    返回
                </button>
            </div>

            <header class="text-center mb-8 border-b pb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">奇美醫療財團法人奇美醫院</h1>
                <h2 class="text-lg sm:text-xl font-semibold text-blue-700 mt-2">全人照護跨領域教學討論滿意度自評表</h2>
            </header>

            <form id="satisfactionForm">

                <fieldset class="mb-8">
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-blue-600 pl-3">一、基本資料</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="name" class="block text-sm font-medium text-gray-600">姓名</label>
                            <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="date" class="block text-sm font-medium text-gray-600">會議日期</label>
                            <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="unit" class="block text-sm font-medium text-gray-600">單位</label>
                            <input type="text" id="unit" name="unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="rank" class="block text-sm font-medium text-gray-600">職級</label>
                            <input type="text" id="rank" name="rank" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="mb-8">
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-blue-600 pl-3 flex items-center">二、滿意度評估 (訓練<span class="text-2xl font-bold text-blue-600 mx-1">前</span>)</legend>
                    <p class="text-sm text-gray-500 mb-4">請在對應的方格內勾選最符合您看法的選項。</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-200 bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="w-1/3">評核項目</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常同意 (5)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">同意 (4)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">普通 (3)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">不同意 (2)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常不同意 (1)</th>
                                </tr>
                            </thead>
                            <tbody id="before-training-body" class="text-sm text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-green-600 pl-3 flex items-center">三、滿意度評估 (訓練<span class="text-2xl font-bold text-green-600 mx-1">後</span>)</legend>
                    <p class="text-sm text-gray-500 mb-4">請在對應的方格內勾選最符合您看法的選項。</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-200 bg-white">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="w-1/3">評核項目</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常同意 (5)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">同意 (4)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">普通 (3)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">不同意 (2)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常不同意 (1)</th>
                                </tr>
                            </thead>
                            <tbody id="after-training-body" class="text-sm text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </fieldset>

                <fieldset class="mt-8">
                     <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-yellow-600 pl-3">四、建議事項</legend>
                    <textarea id="suggestions" name="suggestions" rows="5" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="請在此輸入您的寶貴建議..."></textarea>
                </fieldset>

                <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button type="button" id="saveDraftButton" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        暫存草稿
                    </button>
                    <button type="submit" id="submitButton" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        提交表單
                    </button>
                </div>
                <div id="saveStatus" class="mt-4 text-center text-green-600 font-medium opacity-0">
                    草稿已儲存！
                </div>
            </form>

            <div id="successMessage" class="hidden flex items-center justify-center">
                <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">提交成功！</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">
                                感謝您的填寫，表單已成功提交。
                            </p>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button type="button" id="closeModalButton" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="hidden flex items-center justify-center">
                <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">提交失敗！</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">
                                發生未知錯誤，請檢查您的網路連線或稍後再試。
                            </p>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button type="button" id="closeErrorModalButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DOM Element References ---
            const form = document.getElementById('satisfactionForm');
            const submitButton = document.getElementById('submitButton'); // MODIFIED: Get reference to submit button
            const backButton = document.getElementById('backButton');
            const saveDraftButton = document.getElementById('saveDraftButton');
            const saveStatus = document.getElementById('saveStatus');
            const tableBodyBefore = document.getElementById('before-training-body');
            const tableBodyAfter = document.getElementById('after-training-body');
            const dateInput = document.getElementById('date');
            
            // Modals
            const successMessage = document.getElementById('successMessage');
            const closeModalButton = document.getElementById('closeModalButton');
            const errorMessage = document.getElementById('errorMessage'); // ADDED
            const closeErrorModalButton = document.getElementById('closeErrorModalButton'); // ADDED
            
            // --- Data and Constants ---
            const storageKey_draft = 'satisfactionFormDraft'; // For draft saving
            const storageKey_ipp = 'ippFormData'; // For IPP data from previous page
            
            // IMPORTANT: 這裡已經填入您的 Apps Script 網址
            const appsScriptURL = 'https://script.google.com/macros/s/AKfycbxZfGne5drRfNiM8aBei2v4wp4_da93tz3zzneq59SfNB_WHfllLxC4CLW2G4MYHrLQSQ/exec';

            const questions = [
                '我很清楚各單位在臨床照護上的工作內容及特性',
                '我可以在臨床照護上和各單位做到良好的溝通',
                '我知道什麼時候應該傳達訊息給其他共同照護單位成員以尋求協助',
                '我知道運用什麼管道傳達訊息給其他共同照護單位成員以尋求協助',
                '良好的跨領域照護可以提升病人的品質',
                '良好的跨領域照護教育可以提升自我的臨床能力',
                '良好的跨領域照護教育會改善自我的臨床態度',
                '我會編寫合適的跨領域照護學習教案',
                '整體滿意度'
            ];

            // --- Functions ---
            /**
             * Populates a table with assessment questions and radio buttons.
             * @param {HTMLElement} tableBody - The tbody element to populate.
             * @param {string} period - The assessment period ('before' or 'after').
             */
            function populateTable(tableBody, period) {
                questions.forEach((questionText, index) => {
                    const row = document.createElement('tr');
                    row.className = 'even:bg-gray-50';
                    const questionCell = document.createElement('td');
                    questionCell.textContent = questionText;
                    questionCell.className = 'text-left p-3 font-medium';
                    row.appendChild(questionCell);
                    for (let i = 5; i >= 1; i--) {
                        const cell = document.createElement('td');
                        const radioInput = document.createElement('input');
                        radioInput.type = 'radio';
                        radioInput.name = `q${index}_${period}`; // e.g., q0_before, q1_after
                        radioInput.value = i;
                        radioInput.className = 'mx-auto';
                        // MODIFIED: Both 'before' and 'after' assessments are now required.
                        radioInput.required = true; 
                        cell.appendChild(radioInput);
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                });
            }
            
            /**
             * Saves the current form data to localStorage.
             */
            function saveDraft() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem(storageKey_draft, JSON.stringify(data));
                
                saveStatus.style.opacity = '1';
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                }, 2000);
            }

            /**
             * Loads form data from localStorage and populates the form.
             */
            function loadDraft() {
                const savedData = localStorage.getItem(storageKey_draft);
                if (!savedData) return;

                const data = JSON.parse(savedData);
                for (const [key, value] of Object.entries(data)) {
                    const element = form.elements[key];
                    if (element) {
                        if (element.constructor.name === 'RadioNodeList') {
                            for (const radio of element) {
                                if (String(radio.value) === String(value)) {
                                    radio.checked = true;
                                    break;
                                }
                            }
                        } else if (element.type === 'checkbox') {
                            element.checked = (value === 'true');
                        } else {
                            element.value = value;
                        }
                    }
                }
            }
            
            /**
             * Clears the saved draft from localStorage.
             */
            function clearDraft() {
                localStorage.removeItem(storageKey_draft);
            }

            /**
             * Hides the success modal and resets the form for the next entry.
             */
            function closeModalAndReset() {
                successMessage.classList.add('hidden');
                form.reset();
                dateInput.valueAsDate = new Date(); // Set current date for date input
                loadIppDataIntoForm(); // MODIFIED: Reload IPP data after reset
            }

            // ADDED: Function to hide the error modal
            function closeErrorModal() {
                errorMessage.classList.add('hidden');
            }

            // ADDED: Function to load data from IPP form into this form's fields
            function loadIppDataIntoForm() {
                const ippDataString = localStorage.getItem(storageKey_ipp);
                if (!ippDataString) return;

                const ippData = JSON.parse(ippDataString);
                // Assuming ippData contains keys like 'name', 'unit', 'rank', 'date'
                // that match the IDs of the inputs in this form.
                document.getElementById('name').value = ippData.name || '';
                document.getElementById('unit').value = ippData.unit || '';
                document.getElementById('rank').value = ippData.rank || '';
                // The date might be handled differently, let's keep the default
                if (ippData.date) {
                    document.getElementById('date').value = ippData.date;
                }
            }


            // --- Event Listeners ---

            // Handle back button click
            backButton.addEventListener('click', () => {
                window.history.back(); // Go back to the previous page
            });
            
            // Handle save draft button click
            saveDraftButton.addEventListener('click', saveDraft);

            // Handle form submission
            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent default browser form submission
                
                // Disable submit button to prevent multiple clicks
                submitButton.disabled = true;
                submitButton.textContent = '提交中...';
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');

                // 1. Read IPP form data from localStorage
                const ippDataString = localStorage.getItem(storageKey_ipp);
                const ippData = ippDataString ? JSON.parse(ippDataString) : {};

                // 2. Collect current form data
                const satisfactionFormData = new FormData(form);
                
                // 3. Merge both data sets into a final FormData object
                const finalFormData = new FormData();
                
                // Copy IPP data
                for (const key in ippData) {
                    if (Object.prototype.hasOwnProperty.call(ippData, key)) {
                        if (Array.isArray(ippData[key])) {
                            ippData[key].forEach(item => finalFormData.append(key, item));
                        } else {
                            finalFormData.append(key, ippData[key]);
                        }
                    }
                }

                // Copy satisfaction form data
                for (const [key, value] of satisfactionFormData.entries()) {
                    finalFormData.append(key, value);
                }

                // 4. Send merged data to Apps Script
                fetch(appsScriptURL, {
                    method: 'POST',
                    body: finalFormData,
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                })
                .then(data => {
                    console.log('Submission successful:', data);
                    // Save submitted data to localStorage for teacher review
                    const submitted = {};
                    finalFormData.forEach((value, key) => {
                        if (submitted[key]) {
                            if (Array.isArray(submitted[key])) {
                                submitted[key].push(value);
                            } else {
                                submitted[key] = [submitted[key], value];
                            }
                        } else {
                            submitted[key] = value;
                        }
                    });
                    submitted.status = '待審核';
                    const all = JSON.parse(localStorage.getItem('submittedForms') || '[]');
                    all.push(submitted);
                    localStorage.setItem('submittedForms', JSON.stringify(all));

                    localStorage.removeItem(storageKey_ipp);
                    clearDraft();
                    successMessage.classList.remove('hidden'); // Show success modal
                })
                .catch(error => {
                    console.error('Submission failed:', error);
                    // MODIFIED: Show custom error modal instead of alert
                    errorMessage.classList.remove('hidden');
                })
                .finally(() => {
                    // Re-enable submit button whether successful or not
                    submitButton.disabled = false;
                    submitButton.textContent = '提交表單';
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            });
            
            // Event listeners for modal close buttons
            closeModalButton.addEventListener('click', closeModalAndReset);
            closeErrorModalButton.addEventListener('click', closeErrorModal); // ADDED

            // --- Initialisation ---
            // Set default date
            if (!dateInput.value) {
                dateInput.valueAsDate = new Date();
            }
            // Populate tables
            populateTable(tableBodyBefore, 'before');
            populateTable(tableBodyAfter, 'after');

            // Load data from previous page (IPP form) into relevant fields
            loadIppDataIntoForm();

            // Load draft for this form (will overwrite IPP data if there's a conflict, which is desired)
            loadDraft();
        });
    </script>
</body>
</html>
