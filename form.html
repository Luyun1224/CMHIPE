<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全人照護跨領域教學討論滿意度自評表</title>
    <!-- Include Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Use Noto Sans TC for better Chinese character rendering */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* Custom styles for radio buttons to ensure they are consistently sized */
        input[type="radio"] {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* Style for table headers */
        th {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem 0.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Style for table cells */
        td {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem 0.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Left-align the first column of the table */
        td:first-child {
            text-align: left;
        }
        /* Style for the save status message */
        #saveStatus {
            transition: opacity 0.5s ease-in-out;
        }
        /* Style for the success message modal */
        #successMessage {
            display: none; /* Hidden by default */
            position: fixed;
            inset: 0;
            background-color: rgba(107, 114, 128, 0.5); /* bg-gray-600 bg-opacity-50 */
            overflow-y: auto;
            height: 100%;
            width: 100%;
            z-index: 50;
            display: flex; /* Use flex to center content */
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">

            <!-- Back Button -->
            <div class="mb-6">
                <button id="backButton" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 mr-2 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    返回
                </button>
            </div>

            <!-- Header Section -->
            <header class="text-center mb-8 border-b pb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">奇美醫療財團法人奇美醫院</h1>
                <h2 class="text-lg sm:text-xl font-semibold text-blue-700 mt-2">全人照護跨領域教學討論滿意度自評表</h2>
            </header>

            <!-- Form starts here -->
            <!-- 移除了 action 屬性，改由 JavaScript fetch API 處理提交 -->
            <form id="satisfactionForm">

                <!-- Section 1: Basic Information -->
                <fieldset class="mb-8">
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-blue-600 pl-3">一、基本資料</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="name" class="block text-sm font-medium text-gray-600">姓名</label>
                            <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="date" class="block text-sm font-medium text-gray-600">會議日期</label>
                            <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="unit" class="block text-sm font-medium text-gray-600">單位</label>
                            <input type="text" id="unit" name="unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3">
                            <label for="rank" class="block text-sm font-medium text-gray-600">職級</label>
                            <input type="text" id="rank" name="rank" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                </fieldset>

                <!-- Section 2: Before Training Assessment -->
                <fieldset class="mb-8">
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-blue-600 pl-3 flex items-center">二、滿意度評估 (訓練<span class="text-2xl font-bold text-blue-600 mx-1">前</span>)</legend>
                    <p class="text-sm text-gray-500 mb-4">請在對應的方格內勾選最符合您看法的選項。</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-200 bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="w-1/3">評核項目</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常同意 (5)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">同意 (4)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">普通 (3)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">不同意 (2)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常不同意 (1)</th>
                                </tr>
                            </thead>
                            <tbody id="before-training-body" class="text-sm text-gray-700">
                                <!-- Dynamically generated rows for "before" assessment -->
                            </tbody>
                        </table>
                    </div>
                </fieldset>
                
                <!-- Section 3: After Training Assessment -->
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-green-600 pl-3 flex items-center">三、滿意度評估 (訓練<span class="text-2xl font-bold text-green-600 mx-1">後</span>)</legend>
                    <p class="text-sm text-gray-500 mb-4">請在對應的方格內勾選最符合您看法的選項。</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-200 bg-white">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="w-1/3">評核項目</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常同意 (5)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">同意 (4)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">普通 (3)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">不同意 (2)</th>
                                    <th class="w-[13.3%] text-sm font-medium text-gray-600">非常不同意 (1)</th>
                                </tr>
                            </thead>
                            <tbody id="after-training-body" class="text-sm text-gray-700">
                                <!-- Dynamically generated rows for "after" assessment -->
                            </tbody>
                        </table>
                    </div>
                </fieldset>

                <!-- Section 4: Suggestions -->
                <fieldset class="mt-8">
                     <legend class="text-xl font-semibold text-gray-700 mb-4 border-l-4 border-yellow-600 pl-3">四、建議事項</legend>
                    <textarea id="suggestions" name="suggestions" rows="5" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="請在此輸入您的寶貴建議..."></textarea>
                </fieldset>

                <!-- Action Buttons -->
                <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button type="button" id="saveDraftButton" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        暫存草稿
                    </button>
                    <button type="submit" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        提交表單
                    </button>
                </div>
                <!-- Save Status Message -->
                <div id="saveStatus" class="mt-4 text-center text-green-600 font-medium opacity-0">
                    草稿已儲存！
                </div>
            </form>

            <!-- Success Message Modal -->
            <div id="successMessage" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">提交成功！</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">
                                感謝您的填寫，表單已成功提交。
                            </p>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button type="button" id="closeModalButton" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DOM Element References ---
            const form = document.getElementById('satisfactionForm');
            const backButton = document.getElementById('backButton');
            const saveDraftButton = document.getElementById('saveDraftButton');
            const saveStatus = document.getElementById('saveStatus');
            const tableBodyBefore = document.getElementById('before-training-body');
            const tableBodyAfter = document.getElementById('after-training-body');
            const dateInput = document.getElementById('date');
            const successMessage = document.getElementById('successMessage');
            const closeModalButton = document.getElementById('closeModalButton');
            
            // --- Data and Constants ---
            const storageKey_draft = 'satisfactionFormDraft'; // For draft saving (optional)
            const storageKey_ipp = 'ippFormData'; // For IPP data from previous page
            
            // IMPORTANT: 這裡已經填入您的 Apps Script 網址
            const appsScriptURL = 'https://script.google.com/macros/s/AKfycbwgGfwlycTmQKGujS20bqiRBT3inU39tEUK1XJlcaO6/exec';

            const questions = [
                '我很清楚各單位在臨床照護上的工作內容及特性', // q0
                '我可以在臨床照護上和各單位做到良好的溝通',     // q1
                '我知道什麼時候應該傳達訊息給其他共同照護單位成員以尋求協助', // q2
                '我知道運用什麼管道傳達訊息給其他共同照護單位成員以尋求協助', // q3
                '良好的跨領域照護可以提升病人的品質',           // q4
                '良好的跨領域照護教育可以提升自我的臨床能力',     // q5
                '良好的跨領域照護教育會改善自我的臨床態度',       // q6
                '我會編寫合適的跨領域照護學習教案',              // q7
                '整體滿意度'                                   // q8
            ];

            // --- Functions ---
            /**
             * Populates a table with assessment questions and radio buttons.
             * @param {HTMLElement} tableBody - The tbody element to populate.
             * @param {string} period - The assessment period ('before' or 'after').
             */
            function populateTable(tableBody, period) {
                questions.forEach((questionText, index) => {
                    const row = document.createElement('tr');
                    row.className = 'even:bg-gray-50';
                    const questionCell = document.createElement('td');
                    questionCell.textContent = questionText;
                    questionCell.className = 'text-left p-3 font-medium';
                    row.appendChild(questionCell);
                    for (let i = 5; i >= 1; i--) {
                        const cell = document.createElement('td');
                        const radioInput = document.createElement('input');
                        radioInput.type = 'radio';
                        // 關鍵：這裡加上了 name 屬性，方便收集資料
                        radioInput.name = `q${index}_${period}`; // 例如: q0_before, q1_after
                        radioInput.value = i;
                        radioInput.className = 'mx-auto';
                        if (period === 'before') {
                            radioInput.required = true;
                        }
                        cell.appendChild(radioInput);
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                });
            }
            
            /**
             * Saves the current form data to localStorage.
             */
            function saveDraft() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem(storageKey_draft, JSON.stringify(data));
                
                saveStatus.style.opacity = '1';
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                }, 2000);
            }

            /**
             * Loads form data from localStorage and populates the form.
             */
            function loadDraft() {
                const savedData = localStorage.getItem(storageKey_draft);
                if (!savedData) return;

                const data = JSON.parse(savedData);
                for (const [key, value] of Object.entries(data)) {
                    const element = form.elements[key];
                    if (element) {
                        // Handle radio buttons (RadioNodeList)
                        if (element.constructor.name === 'RadioNodeList') {
                            for (const radio of element) {
                                if (String(radio.value) === String(value)) { // Convert to string for comparison
                                    radio.checked = true;
                                    break;
                                }
                            }
                        } 
                        // Handle checkboxes (if any, though none directly here with a single name)
                        else if (element.type === 'checkbox') {
                            element.checked = (value === 'true'); // Store boolean as string
                        }
                        // Handle textareas and input fields
                        else {
                            element.value = value;
                        }
                    }
                }
            }
            
            /**
             * Clears the saved draft from localStorage.
             */
            function clearDraft() {
                localStorage.removeItem(storageKey_draft);
            }

            /**
             * Hides the success modal and resets the form for the next entry.
             */
            function closeModalAndReset() {
                successMessage.classList.add('hidden');
                form.reset();
                dateInput.valueAsDate = new Date(); // Set current date for date input
            }

            // --- Event Listeners ---

            // Handle back button click
            backButton.addEventListener('click', () => {
                window.history.back(); // Go back to the previous page (IPP form)
            });
            
            // Handle save draft button click
            saveDraftButton.addEventListener('click', saveDraft);

            // Handle form submission
            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent default browser form submission

                // 1. 讀取 IPP 表單的暫存資料
                const ippDataString = localStorage.getItem(storageKey_ipp);
                const ippData = ippDataString ? JSON.parse(ippDataString) : {};

                // 2. 收集自評表的新資料
                const satisfactionFormData = new FormData(form); // Collects data from current form elements
                
                // 3. 將兩份資料合併到一個 FormData 物件中，準備發送
                const finalFormData = new FormData();
                
                // 複製 IPP 資料到最終的 FormData
                for (const key in ippData) {
                    if (Object.prototype.hasOwnProperty.call(ippData, key)) {
                        // 對於陣列型別的資料（例如來自多選框的 professions），需要 append 多次
                        if (Array.isArray(ippData[key])) {
                            ippData[key].forEach(item => {
                                finalFormData.append(key, item);
                            });
                        } else {
                            finalFormData.append(key, ippData[key]);
                        }
                    }
                }

                // 複製自評表資料到最終的 FormData
                for (const [key, value] of satisfactionFormData.entries()) {
                    // 對於 checkbox，如果沒有勾選，FormData 預設不會包含其 name/value。
                    // 如果需要在 Google Sheet 中明確顯示 false/未勾選，
                    // 則需要額外處理，但目前 Apps Script 會將未送出的欄位視為空值。
                    finalFormData.append(key, value);
                }

                // 4. 發送合併後的資料到 Apps Script
                fetch(appsScriptURL, {
                    method: 'POST',
                    body: finalFormData,
                    // 不設定 'Content-Type'，FormData 會自動設定 multipart/form-data
                })
                .then(response => {
                    if (response.ok) {
                        return response.text(); // Apps Script 會回傳 'Submission successful.'
                    } else {
                        // 如果 HTTP 狀態碼不是 2xx (例如 404, 500)，則拋出錯誤
                        throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    }
                })
                .then(data => {
                    console.log('Submission successful:', data);
                    // 提交成功後，清除暫存資料並顯示成功訊息
                    localStorage.removeItem(storageKey_ipp); // 清除 IPP 表單資料
                    clearDraft(); // 清除自評表草稿
                    successMessage.classList.remove('hidden'); // 顯示成功訊息 Modal
                })
                .catch(error => {
                    console.error('Submission failed:', error);
                    alert('提交失敗，請稍後再試。錯誤訊息：' + error.message); // 顯示錯誤訊息
                });
            });
            
            // The close button in the modal will hide the modal and reset the form.
            closeModalButton.addEventListener('click', closeModalAndReset);

            // --- Initialisation ---
            // 設定會議日期為當天
            if (!dateInput.value) {
                dateInput.valueAsDate = new Date();
            }
            // 動態生成評估表格
            populateTable(tableBodyBefore, 'before');
            populateTable(tableBodyAfter, 'after');

            // 載入自評表草稿 (如果有)
            loadDraft();

            // 從 localStorage 載入 IPP 資料到自評表的相關欄位（如果有的話）
            // 由於自評表也有姓名/單位/日期，這裡假設使用者會手動填寫或由 IPP 表單帶過來，
            // 如果自評表的這些欄位需要自動填入 IPP 表單的資料，需要額外增加邏輯。
            // 但目前的 HTML 中自評表的姓名/單位/日期是 required，且有 name 屬性，所以會被FormData收集。
        });
    </script>
</body>
</html>
